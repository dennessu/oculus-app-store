<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="1" author='xmchen' context="PREDEPLOY">
        <sql><![CDATA[
			CREATE TABLE balance (
				balance_id BIGINT NOT NULL,
				user_id BIGINT NOT NULL,
				pi_id BIGINT NOT NULL,
				balance_type_id SMALLINT NOT NULL,
				total_amount DECIMAL NOT NULL,
				tax_amount DECIMAL NOT NULL,
				tax_included BOOLEAN,
				currency CHAR(3) NOT NULL,
				country_code CHAR(2),
				status_id SMALLINT NOT NULL,
				due_date DATE,
				retry_count INT NOT NULL DEFAULT(0),
				decline_count INT NOT NULL DEFAULT(0),
				original_balance_id BIGINT NULL,
				shipping_address_id BIGINT NULL,
				requestor_id VARCHAR(64) NOT NULL,
				onbehalfof_requestor_id VARCHAR(64),
				created_date TIMESTAMP NOT NULL,
				created_by VARCHAR(64) NOT NULL,
				modified_date TIMESTAMP,
				modified_by VARCHAR(64),
				PRIMARY KEY(balance_id)
			);
			CREATE INDEX balance_user_id_idx ON balance (user_id);
			CREATE INDEX balance_pi_id_idx ON balance (pi_id);
			CREATE INDEX balance_status_id_idx ON balance (status_id);
			CREATE INDEX balance_due_date_idx ON balance (due_date);
			CREATE INDEX balance_original_balance_id_idx ON balance (original_balance_id);

			CREATE TABLE balance_event (
				event_id BIGINT NOT NULL,
				balance_id BIGINT NOT NULL,
				action_id SMALLINT NOT NULL,
				status_id SMALLINT NOT NULL,
				event_date TIMESTAMP NOT NULL,
				PRIMARY KEY(event_id)
			);
			CREATE INDEX balance_event_balance_id_idx ON balance_event (balance_id);
			CREATE INDEX balance_event_status_id_idx ON balance_event (status_id);

			CREATE TABLE balance_item (
				balance_item_id BIGINT NOT NULL,
				balance_id BIGINT NOT NULL,
				order_item_id BIGINT NOT NULL,
				amount DECIMAL NOT NULL,
				tax_amount DECIMAL NOT NULL,
				tax_included BOOLEAN,
				finance_id VARCHAR(64),
				is_tax_exempt BOOLEAN,
				original_balance_item_id BIGINT,
				created_date TIMESTAMP NOT NULL,
				created_by VARCHAR(64) NOT NULL,
				modified_date TIMESTAMP,
				modified_by VARCHAR(64),
				PRIMARY KEY(balance_item_id)
			);
			CREATE INDEX balance_item_balance_id_idx ON balance_item (balance_id);
			CREATE INDEX balance_item_order_item_id_idx ON balance_item (order_item_id);
			CREATE INDEX balance_item_original_balance_item_id_idx ON balance_item (original_balance_item_id);

			CREATE TABLE order_balance_link (
				order_balance_link_id BIGINT NOT NULL,
				order_id BIGINT NOT NULL,
				balance_id BIGINT NOT NULL,
				created_date TIMESTAMP NOT NULL,
				created_by VARCHAR(64) NOT NULL,
				modified_date TIMESTAMP,
				modified_by VARCHAR(64),
				PRIMARY KEY(order_balance_link_id)
			);
			CREATE INDEX order_balance_link_order_id_idx ON order_balance_link (order_id);
			CREATE INDEX order_balance_link_balance_id_idx ON order_balance_link (balance_id);

			CREATE TABLE tax_item (
				tax_item_id BIGINT NOT NULL,
				balance_item_id BIGINT NOT NULL,
				tax_authority_id SMALLINT NOT NULL,
				tax_amount DECIMAL NOT NULL,
				tax_rate DECIMAL,
				created_date TIMESTAMP NOT NULL,
				created_by VARCHAR(64) NOT NULL,
				modified_date TIMESTAMP,
				modified_by VARCHAR(64),
				PRIMARY KEY(tax_item_id)
			);
			CREATE INDEX tax_item_balance_item_id_idx ON tax_item (balance_item_id);

			CREATE TABLE discount_item (
				discount_item_id BIGINT NOT NULL,
				balance_item_id BIGINT NOT NULL,
				discount_amount DECIMAL NOT NULL,
				discount_rate DECIMAL,
				created_date TIMESTAMP NOT NULL,
				created_by VARCHAR(64) NOT NULL,
				modified_date TIMESTAMP,
				modified_by VARCHAR(64),
				PRIMARY KEY(discount_item_id)
			);
			CREATE INDEX discount_item_balance_item_id_idx ON discount_item (balance_item_id);
                ]]>
        </sql>
    </changeSet>

    <changeSet id="2" author='xmchen' context="PREDEPLOY">
        <sql><![CDATA[
			CREATE TABLE shipping_address (
				shipping_address_id BIGINT NOT NULL,
				user_id BIGINT NOT NULL,
				street VARCHAR(512) NOT NULL,
				street1 VARCHAR(512),
				street2 VARCHAR(512),
				city VARCHAR(128) NOT NULL,
				state VARCHAR(128),
				postal_code VARCHAR(64) NOT NULL,
				country_code CHAR(2) NOT NULL,
				company_name VARCHAR(256),
				first_name VARCHAR(256) NOT NULL,
				middle_name VARCHAR(256),
				last_name VARCHAR(256) NOT NULL,
				phone_number VARCHAR(128),
				description VARCHAR(512),
				requestor_id VARCHAR(64) NOT NULL,
				onbehalfof_requestor_id VARCHAR(64),
				deleted BOOLEAN NOT NULL DEFAULT(FALSE),
				created_date TIMESTAMP NOT NULL,
				created_by VARCHAR(64) NOT NULL,
				modified_date TIMESTAMP,
				modified_by VARCHAR(64),
				PRIMARY KEY(shipping_address_id)
			);
			CREATE INDEX shipping_address_user_id_idx ON shipping_address (user_id);
			CREATE INDEX shipping_address_deleted_idx ON shipping_address (deleted);
                ]]>
        </sql>
    </changeSet>

    <changeSet id="3" author='xmchen' context="PREDEPLOY">
        <sql><![CDATA[
			CREATE TABLE billing_transaction (
				transaction_id BIGINT NOT NULL,
				balance_id BIGINT NOT NULL,
				pi_id BIGINT NOT NULL,
				type_id SMALLINT NOT NULL,
				payment_ref_id VARCHAR(128) NOT NULL,
				amount DECIMAL NOT NULL,
				currency CHAR(3) NOT NULL,
				status_id SMALLINT NOT NULL,
				created_date TIMESTAMP NOT NULL,
				created_by VARCHAR(64) NOT NULL,
				modified_date TIMESTAMP,
				modified_by VARCHAR(64),
				PRIMARY KEY(transaction_id)
			);
			CREATE INDEX billing_transaction_balance_id_idx ON billing_transaction (balance_id);
			CREATE INDEX billing_transaction_piid_id_idx ON billing_transaction (pi_id);

			CREATE TABLE transaction_event (
				event_id BIGINT NOT NULL,
				transaction_id BIGINT NOT NULL,
				action_id SMALLINT NOT NULL,
				status_id SMALLINT NOT NULL,
				event_date TIMESTAMP NOT NULL,
				PRIMARY KEY(event_id)
			);
			CREATE INDEX billing_transaction_event_transaction_id_idx ON transaction_event (transaction_id);
			CREATE INDEX billing_transaction_event_status_id_idx ON transaction_event (status_id);
                ]]>
        </sql>
    </changeSet>

    <changeSet id="4" author='xmchen' context="PREDEPLOY">
        <sql><![CDATA[
			CREATE TABLE currency (
				currency_name CHAR(3) NOT NULL,
				currency_code CHAR(3) NOT NULL,
				base_units INT NOT NULL,
				decimal_pattern VARCHAR(64) NOT NULL,
				max_balance DECIMAL NOT NULL,
				spending_limit DECIMAL NOT NULL,
				preauth_amount DECIMAL NOT NULL,
				paypal_preauth_amount DECIMAL NOT NULL,
				symbol VARCHAR(32) NOT NULL,
				orientation CHAR(1) NOT NULL,
				description VARCHAR(256),
				created_date DATE NOT NULL,
				created_by VARCHAR(64) NOT NULL,
				PRIMARY KEY(currency_name)
			);
			INSERT INTO currency VALUES('USD', '840', 100, '0.00##', 300, 300, 1, 0.01, '$', 'L', 'US Dollars', '2014-02-21', 'xmchen');
			INSERT INTO currency VALUES('EUR', '978', 100, '0.00##', 120, 220, 1, 0.01, 'â‚¬', 'L', 'Euros', '2014-02-21', 'xmchen');
                ]]>
        </sql>
    </changeSet>
</databaseChangeLog>