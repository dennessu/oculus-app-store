#pgha demo on Mac steps

#purge all
./purge.sh

#initialize and start master database
./build_master.sh

#do full back up for master database
./base_backup.sh

#initialize slave database and setup replication
./build_slave.sh

#configure and start primary/secondary pgbouncer proxies
#these two proxies are both pointing to master database
./pgbouncer_master.sh

#insert data into master database, primary pgbouncer proxy and secondary pgbouncer proxy
#check data had been replicated to slave database correctly
./test_replication.sh

# failover steps:
# - stop primary/secondary pgbouncer proxies
# - gracefully shutdown master database
# - copy unarchived log
# - ensure slave catch up
# - promote slave database as new master
# - configure old master
# - start old master as new slave
# - switch primary/secondary pgbouncer proxies to new master
# - start primary/secondary pgbouncer proxies
./failover.sh

#insert data into new master database, primary pgbouncer proxy and secondary pgbouncer proxy
#check data had been replicated to new slave database correctly
./test_replication_reverse.sh

# similar to failover steps
./failback.sh

./test_replication.sh
