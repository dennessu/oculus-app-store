<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
       ">

    <context:annotation-config />

    <tx:annotation-driven />
    <context:component-scan base-package="com.junbo.identity.data" />
    <import resource="classpath*:spring/sharding.xml"/>
    <import resource="classpath*:spring/sharding-context.xml"/>

    <bean id="__builtinMapper" class="com.junbo.oom.core.builtin.BuiltinMapper" />
    <bean id="__commonMapper" class="com.junbo.identity.data.mapper.CommonMapper" />

    <tx:annotation-driven transaction-manager="transactionManager"/>

    <!-- SessonFactory for Hibernate -->
    <bean id="configSessionFactory"
          class="org.springframework.orm.hibernate4.LocalSessionFactoryBean">
        <property name="dataSource" ref="configDataSource"/>
        <property name="packagesToScan" value="com.junbo.identity.data.entity.domaindata"/>
        <property name="jtaTransactionManager" ref="transactionManager"/>
        <property name="entityInterceptor">
            <bean class="com.junbo.identity.data.dao.interceptor.AuditInterceptor" />
        </property>
        <property name="hibernateProperties">
            <props>
                <prop key="hibernate.dialect">${config.hibernate.dialect}</prop>
                <prop key="hibernate.max_fetch_depth">${config.hibernate.max_fetch_depth}</prop>
                <prop key="hibernate.jdbc.fetch_size">${config.hibernate.fetch_size}</prop>
                <prop key="hibernate.jdbc.batch_size">${config.hibernate.batch_size}</prop>
                <prop key="hibernate.show_sql">${config.hibernate.show_sql}</prop>
            </props>
        </property>
    </bean>

    <bean id="securityQuestionDAO" class="com.junbo.identity.data.dao.impl.SecurityQuestionDAOImpl">
        <property name="sessionFactory" ref="configSessionFactory"/>
    </bean>

    <bean id="sessionFactoryTemplateWithInterceptor" class="org.springframework.orm.hibernate4.LocalSessionFactoryBean">
        <property name="jtaTransactionManager" ref="transactionManager"/>
        <property name="entityInterceptor">
            <bean class="com.junbo.identity.data.dao.interceptor.AuditInterceptor" />
        </property>
        <property name="hibernateProperties">
            <props>
                <prop key="hibernate.dialect">${sharding.hibernate.dialect}</prop>
                <prop key="hibernate.max_fetch_depth">${sharding.hibernate.max_fetch_depth}</prop>
                <prop key="hibernate.jdbc.fetch_size">${sharding.hibernate.fetch_size}</prop>
                <prop key="hibernate.jdbc.batch_size">${sharding.hibernate.batch_size}</prop>
                <prop key="hibernate.show_sql">${sharding.hibernate.show_sql}</prop>
            </props>
        </property>
    </bean>

    <bean id="sessionFactoryWrapper" class="com.junbo.sharding.core.hibernate.SessionFactoryWrapper">
        <property name="mapper" ref="shardDataSourceMapper"/>
        <property name="dataSourceRegistry" ref="shardDataSourceRegistry"/>
        <property name="sessionFactoryBeanName" value="sessionFactoryTemplateWithInterceptor"/>
        <property name="entityInterceptor">
            <bean class="com.junbo.identity.data.dao.interceptor.AuditInterceptor" />
        </property>
        <property name="dataBaseName" value="identity"/>
        <property name="packagesToScan" value="com.junbo.identity.data.entity.*"/>
        <property name="postInsertEventListeners" ref="entityListener" />
        <property name="postUpdateEventListeners" ref="entityListener" />
        <property name="postDeleteEventListeners" ref="entityListener" />
    </bean>

    <bean id="indexSessionFactoryWrapper" class="com.junbo.sharding.core.hibernate.SessionFactoryWrapper">
        <property name="mapper" ref="indexDataSourceMapper"/>
        <property name="dataSourceRegistry" ref="indexDataSourceRegistry"/>
        <property name="sessionFactoryBeanName" value="sessionFactoryTemplateWithInterceptor"/>
        <property name="entityInterceptor">
            <bean class="com.junbo.identity.data.dao.interceptor.AuditInterceptor" />
        </property>
        <property name="dataBaseName" value="index"/>
        <property name="packagesToScan" value="com.junbo.identity.data.entity.reverselookup"/>
        <property name="postInsertEventListeners" ref="entityListener" />
        <property name="postUpdateEventListeners" ref="entityListener" />
        <property name="postDeleteEventListeners" ref="entityListener" />
    </bean>

    <bean id="baseDao" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" abstract="true">
        <property name="idGeneratorFacade" ref="idGeneratorFacade"/>
    </bean>

    <bean id="entityDAOBase" class="com.junbo.identity.data.dao.impl.ShardedDAOBase" abstract="true">
        <property name="viewQueryFactory" ref="defaultViewQueryFactory" />
        <property name="sessionFactoryWrapper" ref="sessionFactoryWrapper" />
    </bean>

    <bean id="entityIndexDAOBase" class="com.junbo.identity.data.dao.impl.ShardedDAOBase" abstract="true">
        <property name="sessionFactoryWrapper" ref="indexSessionFactoryWrapper" />
    </bean>

    <bean id="userDAOTarget" class="com.junbo.identity.data.dao.impl.UserDAOImpl" parent="entityDAOBase" />
    <bean id="userDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.UserDAO"/>
        <property name="daoTarget" ref="userDAOTarget"/>
    </bean>

    <bean id="groupDAOTarget" class="com.junbo.identity.data.dao.impl.GroupDAOImpl" parent="entityDAOBase"/>
    <bean id="groupDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.GroupDAO" />
        <property name="daoTarget" ref="groupDAOTarget" />
    </bean>

    <bean id="userAuthenticatorDAOTarget" class="com.junbo.identity.data.dao.impl.UserAuthenticatorDAOImpl" parent="entityDAOBase" />
    <bean id="userAuthenticatorDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.UserAuthenticatorDAO" />
        <property name="daoTarget" ref="userAuthenticatorDAOTarget" />
    </bean>

    <bean id="userDeviceDAOTarget" class="com.junbo.identity.data.dao.impl.UserDeviceDAOImpl" parent="entityDAOBase"/>
    <bean id="userDeviceDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.UserDeviceDAO" />
        <property name="daoTarget" ref="userDeviceDAOTarget" />
    </bean>

    <bean id="userEmailDAOTarget" class="com.junbo.identity.data.dao.impl.UserEmailDAOImpl" parent="entityDAOBase"/>
    <bean id="userEmailDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.UserEmailDAO" />
        <property name="daoTarget" ref="userEmailDAOTarget" />
    </bean>

    <bean id="userGroupDAOTarget" class="com.junbo.identity.data.dao.impl.UserGroupDAOImpl" parent="entityDAOBase"/>
    <bean id="userGroupDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.UserGroupDAO" />
        <property name="daoTarget" ref="userGroupDAOTarget" />
    </bean>

    <bean id="groupUserDAOTarget" class="com.junbo.identity.data.dao.impl.GroupUserDAOImpl" parent="entityDAOBase"/>
    <bean id="groupUserDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.GroupUserDAO" />
        <property name="daoTarget" ref="groupUserDAOTarget" />
    </bean>

    <bean id="userLoginAttemptDAOTarget" class="com.junbo.identity.data.dao.impl.UserLoginAttemptDAOImpl" parent="entityDAOBase"/>
    <bean id="userLoginAttemptDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.UserLoginAttemptDAO" />
        <property name="daoTarget" ref="userLoginAttemptDAOTarget" />
    </bean>

    <bean id="userOptinDAOTarget" class="com.junbo.identity.data.dao.impl.UserOptinDAOImpl" parent="entityDAOBase"/>
    <bean id="userOptinDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.UserOptinDAO" />
        <property name="daoTarget" ref="userOptinDAOTarget" />
    </bean>

    <bean id="userPasswordDAOTarget" class="com.junbo.identity.data.dao.impl.UserPasswordDAOImpl" parent="entityDAOBase"/>
    <bean id="userPasswordDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.UserPasswordDAO" />
        <property name="daoTarget" ref="userPasswordDAOTarget" />
    </bean>

    <bean id="userPhoneNumberDAOTarget" class="com.junbo.identity.data.dao.impl.UserPhoneNumberDAOImpl" parent="entityDAOBase" />
    <bean id="userPhoneNumberDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.UserPhoneNumberDAO" />
        <property name="daoTarget" ref="userPhoneNumberDAOTarget" />
    </bean>

    <bean id="userPinDAOTarget" class="com.junbo.identity.data.dao.impl.UserPinDAOImpl" parent="entityDAOBase" />
    <bean id="userPinDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.UserPinDAO" />
        <property name="daoTarget" ref="userPinDAOTarget" />
    </bean>

    <bean id="userSecurityQuestionDAOTarget" class="com.junbo.identity.data.dao.impl.UserSecurityQuestionDAOImpl" parent="entityDAOBase" />
    <bean id="userSecurityQuestionDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.UserSecurityQuestionDAO" />
        <property name="daoTarget" ref="userSecurityQuestionDAOTarget" />
    </bean>

    <bean id="userTosDAOTarget" class="com.junbo.identity.data.dao.impl.UserTosDAOImpl" parent="entityDAOBase" />
    <bean id="userTosDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.UserTosDAO" />
        <property name="daoTarget" ref="userTosDAOTarget" />
    </bean>

    <bean id="userNameDAOTarget" class="com.junbo.identity.data.dao.impl.UserNameDAOImpl" parent="entityDAOBase"/>
    <bean id="userNameDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.UserNameDAO" />
        <property name="daoTarget" ref="userNameDAOTarget" />
    </bean>

    <bean id="userSecurityQuestionAttemptDAOTarget" class="com.junbo.identity.data.dao.impl.UserSecurityQuestionAttemptDAOImpl" parent="entityDAOBase" />
    <bean id="userSecurityQuestionAttemptDAO" class="com.junbo.sharding.core.ShardAwareDaoFactoryBean" parent="baseDao">
        <property name="daoInterface" value="com.junbo.identity.data.dao.UserSecurityQuestionAttemptDAO" />
        <property name="daoTarget" ref="userSecurityQuestionAttemptDAOTarget" />
    </bean>

    <bean id="groupRepository" class="com.junbo.identity.data.repository.impl.GroupRepositoryImpl" />
    <bean id="userAuthenticatorRepository" class="com.junbo.identity.data.repository.impl.UserAuthenticatorRepositoryImpl" />
    <bean id="userDeviceRepository" class="com.junbo.identity.data.repository.impl.UserDeviceRepositoryImpl" />
    <bean id="userEmailRepository" class="com.junbo.identity.data.repository.impl.UserEmailRepositoryImpl" />
    <bean id="userGroupRepository" class="com.junbo.identity.data.repository.impl.UserGroupRepositoryImpl" />
    <bean id="userLoginAttemptRepository" class="com.junbo.identity.data.repository.impl.UserLoginAttemptRepositoryImpl" />
    <bean id="userOptinRepository" class="com.junbo.identity.data.repository.impl.UserOptinRepositoryImpl" />
    <bean id="userPasswordRepository" class="com.junbo.identity.data.repository.impl.UserPasswordRepositoryImpl" />
    <bean id="userPhoneNumberRepository" class="com.junbo.identity.data.repository.impl.UserPhoneNumberRepositoryImpl" />
    <bean id="userPinRepository" class="com.junbo.identity.data.repository.impl.UserPinRepositoryImpl" />
    <bean id="userRepository" class="com.junbo.identity.data.repository.impl.UserRepositoryImpl" />
    <bean id="userSecurityQuestionRepository" class="com.junbo.identity.data.repository.impl.UserSecurityQuestionRepositoryImpl" />
    <bean id="userTosRepository" class="com.junbo.identity.data.repository.impl.UserTosRepositoryImpl" />
    <bean id="securityQuestionRepository" class="com.junbo.identity.data.repository.impl.SecurityQuestionRepositoryImpl"/>
    <bean id="userSecurityQuestionAttemptRepository" class="com.junbo.identity.data.repository.impl.UserSecurityQuestionAttemptRepositoryImpl" />

    <bean id="defaultEntityViewRepository" class="com.junbo.sharding.view.DefaultEntityViewRepository">
        <property name="entityViews">
            <list>
                <bean class="com.junbo.identity.data.view.UsernameView" />
                <bean class="com.junbo.identity.data.view.GroupNameView" />
                <bean class="com.junbo.identity.data.view.AuthenticatorValueView" />
                <bean class="com.junbo.identity.data.view.UserEmailView" />
            </list>
        </property>
    </bean>

    <bean id="multimapDAO" class="com.junbo.sharding.view.DefaultMultimapDAO">
        <property name="sessionFactoryWrapper" ref="indexSessionFactoryWrapper" />
        <property name="shardAlgorithm" ref="userShardAlgorithm" />
    </bean>

    <bean id="entityListener" class="com.junbo.sharding.view.EntityListener">
        <property name="entityViewRepository" ref="defaultEntityViewRepository" />
        <property name="multimapDAO" ref="multimapDAO" />
    </bean>

    <bean id="defaultViewQueryFactory" class="com.junbo.sharding.view.DefaultViewQueryFactory">
        <property name="entityViewRepository" ref="defaultEntityViewRepository" />
        <property name="multimapDAO" ref="multimapDAO" />
    </bean>
</beans>