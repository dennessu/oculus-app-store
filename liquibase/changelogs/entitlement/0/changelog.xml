<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="1" author='NanXin' context="PREDEPLOY">
        <sql><![CDATA[
            create table entitlement (
              entitlement_id bigint not null,
              rev int not null,
              user_id bigint not null,
              type smallint not null,
              entitlement_group varchar(512) not null,
              tag varchar(512) not null,
              is_banned boolean not null,
              grant_time timestamp not null,
              expiration_time timestamp default null,
              in_app_context json default null,
              use_count bigint default null,
              entitlement_definition_id bigint default null,
              created_by varchar(32) default null,
              modified_by varchar(32) default null,
              created_time timestamp not null,
              modified_time timestamp not null,
              tracking_uuid uuid UNIQUE,
              is_deleted boolean default null,
              primary key (entitlement_id)
            );
            create table entitlement_history (
              entitlement_history_id bigint not null,
              action varchar(32) not null,
              entitlement_id bigint not null,
              rev int not null,
              is_banned boolean not null,
              entitlement_definition_id bigint default null,
              user_id bigint not null,
              type smallint not null,
              entitlement_group varchar(512) not null,
              tag varchar(512) not null,
              grant_time timestamp not null,
              expiration_time timestamp default null,
              in_app_context json default null,
              use_count bigint default null,
              created_by varchar(32) default null,
              modified_by varchar(32) default null,
              created_time timestamp not null,
              modified_time timestamp not null,
              is_deleted boolean default null,
              primary key (entitlement_history_id)
            );
            CREATE OR REPLACE FUNCTION json_val_arr(_j json)
          RETURNS text[] AS
        $$
          SELECT array_agg(text(elem))
          FROM json_array_elements(_j) AS x(elem)
        $$
        LANGUAGE sql IMMUTABLE;
        CREATE INDEX entitlement_in_app_context_gin_idx ON entitlement
      USING GIN (json_val_arr(in_app_context));
                ]]>
        </sql>
    </changeSet>

</databaseChangeLog>