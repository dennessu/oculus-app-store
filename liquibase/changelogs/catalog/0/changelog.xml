<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="1" author='baojing' context="PREDEPLOY">
        <sql><![CDATA[
            create table item (
              item_id                 bigint            not null,
              type                    varchar(64)       not null,
              item_name               json              not null,
              curated                 boolean           not null default false,
              owner_id                bigint            not null,
              genres                  bigint[]          null,
              current_revision_id     bigint            null,
              payload                 json              not null,
              deleted                 boolean           not null default false,
              created_by              varchar(64)       not null,
              created_time            timestamp         not null,
              updated_by              varchar(64)       default null,
              updated_time            timestamp         default null,

              primary key (item_id)
            );

            create table item_revision (
              revision_id             bigint            not null,
              item_id                 bigint            not null,
              type                    varchar(64)       not null,
              status                  varchar(64)       not null,
              owner_id                bigint            not null,
              payload                 json              not null,
              timestamp               bigint            null,
              deleted                 boolean           not null default false,
              created_by              varchar(64)       not null,
              created_time            timestamp         not null,
              updated_by              varchar(64)       default null,
              updated_time            timestamp         default null,

              primary key (revision_id)
            );

            create table offer (
              offer_id                bigint            not null,
              offer_name              json              not null,
              curated                 boolean           not null default false,
              owner_id                bigint            not null,
              current_revision_id     bigint            null,
              categories              bigint[]          null,
              deleted                 boolean           not null default false,
              created_by              varchar(64)       not null,
              created_time            timestamp         not null,
              updated_by              varchar(64)       default null,
              updated_time            timestamp         default null,

              primary key (offer_id)
            );

            create table offer_revision (
              revision_id             bigint            not null,
              offer_id                bigint            not null,
              status                  varchar(64)       not null,
              owner_id                bigint            not null,
              payload                 json              not null,
              timestamp               bigint            null,
              deleted                 boolean           not null default false,
              created_by              varchar(64)       not null,
              created_time            timestamp         not null,
              updated_by              varchar(64)       default null,
              updated_time            timestamp         default null,

              primary key (revision_id)
            );

            create table attribute (
              id                      bigint            not null,
              type                    varchar(64)       not null,
              name                    json              not null,
              payload                 json              not null,
              deleted                 boolean           not null default false,
              created_by              varchar(64)       not null,
              created_time            timestamp         not null,
              updated_by              varchar(64)       default null,
              updated_time            timestamp         default null,

              primary key (id)
            );

            create table price_tiers (
              id                      bigint            not null,
              name                    varchar(64)       not null,
              payload                 json              not null,
              deleted                 boolean           not null default false,
              created_by              varchar(64)       not null,
              created_time            timestamp         not null,
              updated_by              varchar(64)       default null,
              updated_time            timestamp         default null,

              primary key (id)
            );
                ]]>
        </sql>
    </changeSet>
    <changeSet id="2" author='lizwu' context="PREDEPLOY">
        <sql><![CDATA[
            create table promotion (
                promotion_id            bigint            not null,
                type                    varchar(64)       not null,
                promotion_name          json              not null,
                curated                 boolean           not null default false,
                owner_id                bigint            not null,
                current_revision_id     bigint            null,
                start_date              timestamp         null,
                end_date                timestamp         null,
                payload                 json              not null,
                deleted                 boolean           not null default false,
                created_by              varchar(64)       not null,
                created_time            timestamp         not null,
                updated_by              varchar(64)       default null,
                updated_time            timestamp         default null,

                primary key (promotion_id)
            );
            
            create table promotion_revision (
                revision_id             bigint            not null,
                promotion_id            bigint            not null,
                type                    varchar(64)       not null,
                status                  varchar(64)       not null,
                owner_id                bigint            not null,
                start_date              timestamp         not null,
                end_date                timestamp         not null,
                payload                 json              not null,
                deleted                 boolean           not null default false,
                created_by              varchar(64)       not null,
                created_time            timestamp         not null,
                updated_by              varchar(64)       default null,
                updated_time            timestamp         default null,

                primary key (revision_id)
            );
        ]]>
        </sql>
    </changeSet>
    <changeSet id="3" author='nanxin' context="PREDEPLOY">
        <sql><![CDATA[
            create table entitlement_definition(
              entitlement_definition_id       bigint       not null,
              developer_id                    bigint       not null,
              rev                             int          not null,
              in_app_context                  json default null,
              type                            smallint     default null,
              entitlement_group               varchar(64)  default null,
              tag                             varchar(64)  not null,
              consumable                      boolean      not null,
              created_by                      varchar(32)  not null,
              updated_by                      varchar(32)  default null,
              created_time                    timestamp    not null,
              updated_time                    timestamp    default null,
              tracking_uuid                   uuid         UNIQUE,
              deleted                         boolean      not null default false,
              primary key (entitlement_definition_id)
            );
            CREATE OR REPLACE FUNCTION json_val_arr(_j json)
            RETURNS text[] AS
            $$
             SELECT array_agg(text(elem))
             FROM json_array_elements(_j) AS x(elem)
            $$
            LANGUAGE sql IMMUTABLE;
            CREATE INDEX entitlement_definition_in_app_context_gin_idx ON entitlement_definition
            USING GIN (json_val_arr(in_app_context));
            insert into entitlement_definition values (177536427572383, 177536427572383, 0, null, 0, '', '', false, 'nanxin', null, '2014-02-10', null, null, false);
        ]]>
        </sql>
    </changeSet>
</databaseChangeLog>
